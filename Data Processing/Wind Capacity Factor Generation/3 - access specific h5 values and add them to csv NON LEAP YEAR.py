'''
The script will extract the data from an h5 file. It extracts data based on points specified, 
then calculates capacity factors for those points, then prints them to csv's.
'''
import os
path = 'D:\Hawaii_h5'
os.chdir(path)

import h5py
import numpy as np
import sys
import argparse
import pandas as pd
import csv



f = h5py.File('Hawaii_2019_100m.h5', 'r')
print(f.keys())

list = [139171,139172,139678,139679,139680,139681,139682,140186,140187,140188,140189,140190,140191,140192,140193,140696,140697,140698,140699,140700,140701,140702,140703,140704,141205,141206,141207,141208,141210,141213,141214,141716,141717,141718,141719,141720,141721,141724,141725,141726,141727,142228,142229,142230,142231,142232,142233,142237,142238,142239,142240,142738,142739,142740,142741,142742,142743,142744,142745,142746,142750,142751,142752,142753,143250,143251,143252,143253,143254,143255,143256,143257,143258,143261,143262,143263,143264,143265,143266,143267,143268,143764,143765,143766,143767,143768,143769,143770,143774,143775,143776,143777,143778,143779,143780,143781,143782,143783,144278,144279,144280,144281,144282,144283,144284,144285,144286,144287,144288,144289,144290,144291,144292,144293,144294,144295,144296,144297,144298,144299,144794,144795,144796,144797,144798,144799,144800,144801,144802,144803,144804,144805,144806,144807,144808,144809,144810,144811,144812,144813,144814,144815,145309,145310,145311,145312,145313,145314,145315,145316,145317,145318,145319,145320,145321,145322,145323,145324,145325,145326,145327,145328,145329,145330,145331,145825,145826,145827,145828,145829,145830,145831,145832,145833,145834,145835,145836,145837,145838,145839,145840,145841,145842,145843,145844,145845,145846,145847,145848,146342,146343,146344,146345,146346,146347,146348,146349,146350,146351,146352,146353,146354,146355,146356,146357,146358,146359,146360,146361,146362,146363,146364,146365,146858,146859,146860,146861,146862,146863,146864,146865,146866,146867,146868,146869,146870,146871,146872,146873,146874,146875,146876,146877,146878,146879,146880,146881,147376,147377,147378,147379,147380,147381,147382,147383,147384,147385,147386,147388,147389,147390,147391,147392,147393,147394,147395,147396,147397,147892,147893,147894,147895,147896,147897,147898,147899,147900,147905,147906,147907,147908,147909,147910,147911,147912,147913,147914,148410,148411,148412,148413,148414,148415,148416,148417,148423,148424,148425,148427,148428,148429,148430,148431,148927,148928,148929,148930,148931,148932,148933,148941,148942,148943,148944,148945,149445,149446,149447,149448,149449,149450,149458,149459,149460,149461,149963,149964,149965,149966,149967,149968,149970,149972,149973,149974,149975,149976,149977,150482,150483,150484,150485,150486,150487,150489,150491,150492,150493,150494,150495,150496,150497,151000,151001,151002,151003,151004,151005,151006,151008,151009,151010,151011,151014,151015,151518,151519,151520,151521,151522,151524,151526,151527,151528,151529,151530,152038,152039,152040,152041,152042,152043,152044,152045,152046,152047,152048,152049,152558,152559,152560,152561,152563,152564,152565,152566,152567,152568,152569,153078,153079,153080,153082,153083,153084,153085,153086,153087,153088,153089,153599,153600,153602,153603,153604,153605,153606,153607,153608,153609,154119,154120,154121,154122,154123,154124,154125,154126,154129,154638,154639,154640,154641,154642,154643,154644,154645,155159,155160,155161,155162,155163,155680,155681,155682,156201,156202
]
#print(list)
#print(len(list))

newdf = pd.DataFrame()

for i in list:
    #Get the data from the columns of the h5 file
    #data = f["key"][column start:column end+1 ,row start:row end +1]
    data = f["windspeed_100m"][0:105120 , [i]]
    print(data)
    #print(data.shape)
    #print(data.size)
    newdf = pd.concat([newdf, pd.DataFrame(data)], axis=1)
f.close()

#print(newdf)

#transpose newdf
newdf = newdf.T
#print(newdf)

#turn newdf into an array
newdf_array = newdf.to_numpy()
#print(newdf_array)
#print(newdf_array.shape)

hourly_wind = np.average(newdf_array.reshape(-1, 12), axis=1)
#print(hourly_wind)
#print(hourly_wind.shape)


hourly_wind = np.array(hourly_wind).reshape(-1, 8760)
#print(hourly_wind)
#print(hourly_wind.shape)

#Divide each value in hourly_wind by 100 to get the wind speed in m/s
hourly_wind = hourly_wind/100
#print(hourly_wind)
#print(hourly_wind.shape)

#turn hourly_wind into a dataframe
u_ci = 3 # cut in speed in m/s
u_r = 12 # rated speed in m/s
u_co = 25 # cut out speed in m/s
wind_cfs = np.zeros((8760, 1))
wind_cfs_2 = pd.DataFrame()
wind_cfs_3 = pd.DataFrame()


hourly_wind = pd.DataFrame(hourly_wind)
#print(hourly_wind)
#print(len(hourly_wind))
for i in range(0, len(hourly_wind)):
    wind = hourly_wind.iloc[[i]]
    #transpose wind
    wind = wind.T
    print(wind)
    print(len(wind))
    for x in range(len(wind)):
        if wind.iloc[x,0] < 3:
            wind_cfs[x] = 0
        elif wind.iloc[x,0] >= 3 and wind.iloc[x,0] < 12:
            wind_cfs[x] = (wind.iloc[x,0]**3)/(u_r**3)
        elif wind.iloc[x,0] >= 12 and wind.iloc[x,0] <= 25:
            wind_cfs[x] = 1
        elif wind.iloc[x,0] > 25:
            wind_cfs[x] = 0
    print(wind_cfs)
    print(wind_cfs.shape)
    #turn wind_cfs into a dataframe
    wind_cfs_2 = pd.DataFrame(wind_cfs)
    #concat wind_cfs_2 to wind_cfs_3
    wind_cfs_3 = pd.concat([wind_cfs_3, wind_cfs_2], axis=1)
    print(wind_cfs_3)
    print(wind_cfs_3.shape)
wind_cfs_3 = wind_cfs_3.T
print(wind_cfs_3)
print(wind_cfs_3.shape)
        

path = "C:/Users/Dominic/Desktop/WIND Toolkit cfs with leap/2019"
os.chdir(path)
#get name of each file in path
file_names = os.listdir(path)
#print(file_names)

print(wind_cfs_3[1])
print(wind_cfs_3.iloc[[1]])
print(wind_cfs_3.iloc[1,:])
#for name in file_names, create a new csv with the name
for i in range(0, len(file_names)):
    with open(file_names[i], 'w') as f:
        writer = csv.writer(f)
        writer.writerow(wind_cfs_3.iloc[i,:])

